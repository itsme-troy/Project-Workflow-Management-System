{% extends 'project/base.html'%} <!-- use the base file -->
{% load static %}

{% block content %} <!-- content of all web pages go -->


<div class="table-container"> 
    <center> <h1 style="display: inline-block; margin-left: -140px">My Received Proposals </h1> 
        <div class="button" style="float: left;">
            <!-- Toggle Button to Show/Hide Links -->
            <button id="toggleButton" onclick="toggleLinks()">Projects</button>

            <!-- Links Section (Initially hidden) -->
            <div id="linksSection" class="hidden "style="float: left;">
                <ul>
                    <li><a href="{% url 'adviser-projects' %}"> Projects</a></li>
                    <li><a href="{% url 'adviser-proposals' %}"> Proposals</a></li>
                    <li><a href="{% url 'panel-projects' %}">Panel Projects</a></li>
                </ul>
            </div>
        </div> 

        <div class="button-container" style="float: right;">  <!-- Using gap to space out buttons -->
            <a href="javascript:history.back()" class="btn btn-outline-secondary btn-sm">Back</a>
        </div>
    </center> 

    {% if not not_approved_projects_with_groups %}

        <center>
            <div class="alert alert-danger" role="alert">
                <h4> You have not received any Project Proposals yet.</h4> 
            </div> </center>
            
    {% else %}
            <table class="table table-hover table-bordered">
                <thead>
                    <tr>
                        <th scope="col"> # </th>
                        <th scope="col">Project Name</th>
                        <th scope="col">Proponents</th>
                        <th scope="col">Adviser</th>
                        <th scope="col">Panel 1 </th>
                        <th scope="col">Panel 2 </th>
                        <th scope="col">Panel 3 </th>
                        <th scope="col"> Actions</th>
                        <th scope="col"> Status </th> 
                        
                    </tr>
                </thead>
                <tbody>
                    {% if not_approved_projects_with_groups %}
                        {% for project_data in not_approved_projects_with_groups %}
                        
                        <tr onclick="toggleActions(this)">
                                <td> <strong> {{ forloop.counter }} </strong> </td>
                                <td> <a href="{% url 'show-proposal' project_data.project.id %}">{{ project_data.project }}</a> </td>
                                <td>{{ project_data.project.proponents }}</td>
                                <td>{{ project_data.project.adviser }}</td>

                                {% for panelist in project_data.panel %}
                                <td>
                                    {% if panelist %}
                                        {{ project_data.panelist.first_name }} {{ panelist.last_name }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                {% endfor %}

                                <td> 
                                    {% if user == project_data.project.adviser %}
                                        <span class="hint-button" onclick="showActions(this)">Click row to show actions</span>
                                        <div class="action-buttons small-btn" style="display: none;">

                                            <a href="{% url 'accept-proposal' project_data.project.id %}"
                                            class="btn btn-outline-success btn-sm"
                                            onclick="return confirm('Are you sure you want to accept this proposal? Accepting will automatically decline other pending proposals received from this group.');"> Accept Proposal  </a> 
                                    
                                            <a href="{% url 'add-comments' project_data.project.id %}"
                                                class="btn btn-outline-secondary btn-sm"> Add Comments </a>   
                                            
                                            {% if project_data.project.status != 'declined' %}
                                                <a href="{% url 'reject-proposal' project_data.project.id %}"
                                                    class="btn btn-outline-danger btn-sm"
                                                    onclick="return confirm('Are you sure you want to decline this proposal?');"> Decline Proposal  </a> 
                                            {% endif %}

                                            {% if project_data.project.status == 'declined' %}
                                                <a href="{% url 'delete-proposal' project_data.project.id %}"
                                                class="btn btn-outline-danger btn-sm"
                                                onclick="return confirm('Are you sure you want to delete this proposal?');"> Delete Proposal </a>
                                            {% endif %}
                                        </div>
                                    {% endif %} 
                                </td>

                                <td>
                                    <span class="badge 
                                        {% if project_data.project.status == 'approved' %}
                                            bg-success
                                        {% elif project_data.project.status == 'pending' %}
                                            bg-warning text-dark
                                        {% elif project_data.project.status == 'declined' %}
                                            bg-danger
                                        {% else %}
                                            bg-secondary
                                        {% endif %}
                                    "> {{ project_data.project.status }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        
                
                    {% endif %}
                        
                </tbody>
            </table>
    {% endif %}

    <hr/> 


    <nav aria-label="Not Approved Projects Pagination">
        <ul class="pagination justify-content-center">
            {% if not_approved_page_obj.has_previous %}
                <li class="page-item"><a class="page-link" href="?not_approved_page=1">&laquo; First</a></li>
                <li class="page-item"><a class="page-link" href="?not_approved_page={{ not_approved_page_obj.previous_page_number }}">Previous</a></li>
            {% endif %}

            {% for num in not_approved_page_obj.paginator.page_range %}
                <li class="page-item {% if num == not_approved_page_obj.number %}active{% endif %}">
                    <a class="page-link" href="?not_approved_page={{ num }}">{{ num }}</a>
                </li>
            {% endfor %}

            {% if not_approved_page_obj.has_next %}
                <li class="page-item"><a class="page-link" href="?not_approved_page={{ not_approved_page_obj.next_page_number }}">Next</a></li>
                <li class="page-item"><a class="page-link" href="?not_approved_page={{ not_approved_page_obj.paginator.num_pages }}">Last &raquo;</a></li>
            {% endif %}
        </ul>
    </nav>
</div>
    <script>
        function toggleActions(row) {
            // Remove active class from all rows
            document.querySelectorAll('tr').forEach(tr => tr.classList.remove('active'));
            // Add active class to clicked row
            row.classList.add('active');
        }

        function showActions(hintButton) {
            // Hide all hint buttons and show action buttons
            document.querySelectorAll('.hint-button').forEach(btn => btn.style.display = 'inline');
            document.querySelectorAll('.action-buttons').forEach(btns => btns.style.display = 'none');

            // Show the action buttons for the clicked row and hide the hint button
            hintButton.style.display = 'none';
            hintButton.nextElementSibling.style.display = 'block'; // Show action buttons
        }

        // Add click handler to close rows when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('tr')) {
                document.querySelectorAll('tr').forEach(tr => tr.classList.remove('active'));
                // Reset hint buttons and action buttons
                document.querySelectorAll('.hint-button').forEach(btn => btn.style.display = 'inline');
                document.querySelectorAll('.action-buttons').forEach(btns => btns.style.display = 'none');
            }
        });

        function toggleLinks() {
            var linksSection = document.getElementById("linksSection");
            var button = document.getElementById("toggleButton");
            
            if (linksSection.classList.contains("hidden")) {
                linksSection.classList.remove("hidden");
                linksSection.classList.add("show");
                button.innerText = "close"; // Change button text when links are visible
            } else {
                linksSection.classList.remove("show");
                linksSection.classList.add("hidden");
                button.innerText = "Projects"; // Change button text when links are hidden
            }
        }

    </script>

{% endblock %}

