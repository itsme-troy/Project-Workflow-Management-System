{% extends 'project/base.html' %}
{% load static %}
{% block styles %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
{% endblock %}

{% block content %}

<div class="table-container"> 
    
<center> <h1 style="display: inline-block;"> My Project Group Waitlist </h1> 
    
    <!-- Button Container -->
    <div class="button-container" style="float: left;">
        <a href="{% url 'join-group-list' %}" class="btn btn-outline-success btn-sm">
            <i class="fas fa-user-plus"></i> Join
        </a>
        <a href="{% url 'add-project-group' %}" class="btn btn-outline-primary btn-sm">
            <i class="fas fa-plus-circle"></i> Register
        </a>
    </div>
    
    <div class="button-container" style="float: right;">
        <a href="javascript:history.back()" class="btn btn-outline-secondary btn-sm" 
        style="float: right;"> Back </a> 
    </div> </center> 
    <br/>

{% if not groups_with_all_members%}
    <center>
        <div class="alert custom-info-alert" role="alert">
            <h5> No Project Group Invitations Available at the moment. </h5> 
        </div> 
    </center> 

{% else %}

    {% if groups_with_all_members %} 
        {% for group_data in groups_with_all_members %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Project Group</h5>
                </div>
                <div class="card-body">   
                    <table class="table">
                        <thead>

                            <tr>
                                {% comment %} <th scope="col"> # </th> {% endcomment %}
                                <th scope="col" class="picture-column">Picture</th> 
                                <th scope="col"> Proponent </th>
                                <th scope="col"> Status </th>
                                <th scope="col" class="action-column"> Actions</th>
                            
                            </tr>
                        </thead>
                        <tbody>
                            {% for proponent in group_data.current_proponents %}
                                <tr {% if user == proponent %}class="table-warning"{% endif %} onclick="toggleActions(this)">
                                    {% comment %} <td> <strong> {{ forloop.counter }} </strong> </td> {% endcomment %}
                                    <td>
                                        {% if proponent.profile_image and proponent.profile_image.url != '/media/static/images/default_profile_pic.jpg' %}
                                            <img src="{{ proponent.profile_image.url }}" alt="profile_pic" class="user-pic-table img-fluid larger-img">
                                      {% else %}
                                        {% comment %} no {% endcomment %}
                                            <img src="{% static '/images/default_profile_pic.jpg' %}" class="img-fluid user-pic-table larger-img"> 
                                      {% endif %}
                                    </td>
                                    
                                    <td>
                                        {{ proponent.get_full_name }}
                                        {% if user == proponent %}
                                            <span class="badge bg-info ms-2">You</span>
                                        {% endif %}
                                        {% if proponent == group_data.group.creator %}
                                            <span class="badge bg-primary">Leader</span>
                                        {% endif %}
                                    </td>
                                    <td><span class="badge bg-success">Approved</span></td>
                                    <td class="action-cell">
                                        {% if user == proponent %}
                                            <span class="hint-button" onclick="showActions(this)">Click row to show actions</span>
                                            
                                            <!-- Action buttons container, initially hidden -->
                                            <div class="action-buttons" style="display: none;">
                                                <a href="{% url 'leave-group' group_data.group.id %}" class="btn btn-outline-danger btn-sm"
                                                    onclick="return confirm('Are you sure you want to leave this group? {% if group_data.current_proponents.count > 1 %}The creator role will be transferred to another member.{% else %}The group will be deleted as you are the only member.{% endif %}')">
                                                    Leave Group
                                                </a>
                                                {% if user == group_data.group.creator %}
                                                    <a href="{% url 'transfer-creator' group_data.group.id %}" class="btn btn-outline-primary btn-sm">
                                                        Transfer Leader role
                                                    </a>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}

                            {% for pending in group_data.pending_proponents %}
                                <tr {% if user == pending %}class="table-warning"{% endif %} onclick="toggleActions(this)">
                                    
                                    {% comment %} <td> <strong> {{ forloop.counter }} </strong> </td> {% endcomment %}
                                    <td>
                                        {% if proponent.profile_image and proponent.profile_image.url != '/media/static/images/default_profile_pic.jpg' %}
                                            <img src="{{ proponent.profile_image.url }}" alt="profile_pic" class="user-pic-table img-fluid larger-img">
                                        {% else %}
                                        {% comment %} no {% endcomment %}
                                            <img src="{% static '/images/default_profile_pic.jpg' %}" class="img-fluid user-pic-table larger-img"> 
                                        {% endif %}
                                    </td>
                                    
                                    <td>
                                        {{ pending.get_full_name }}
                                        {% if user == pending %}
                                            <span class="badge bg-info ms-2">You</span>
                                        {% endif %}
                                    </td>
                                    <td><span class="badge bg-warning text-dark">Pending</span></td>
                                    <td class="action-cell">
                                        {% if user == pending %}    
                                            <span class="hint-button">Click row to show actions</span>
                                            <div class="action-buttons">
                                            <a href="{% url 'approve-group-membership' group_data.group.id %}" class="btn btn-outline-success btn-sm" onclick="return confirm('Are you sure you want to accept this invitation? By accepting this invitation, all other project group invitations will be automatically declined.')">Accept Invitation</a>
                                            <a href="{% url 'reject-group-membership' group_data.group.id %}" class="btn btn-outline-danger btn-sm" onclick="return confirm('Are you sure you want to reject this invitation?')">Reject Invitation</a>
                                        {% endif %}
                                            {% if user == group_data.group.creator %}
                                            <span class="hint-button">Click row to show actions</span>
                                            <div class="action-buttons">
                                                <a href="{% url 'remove-member' group_data.group.id pending.id %}" class="btn btn-outline-danger btn-sm"
                                                    onclick="return confirm('Are you sure you want to remove this member?')">Remove Member</a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}

                            {% for declined in group_data.declined_proponents %}
                                <tr {% if user == declined %}class="table-warning"{% endif %} onclick="toggleActions(this)">
                                  
                                    <td>
                                        {% if proponent.profile_image and proponent.profile_image.url != '/media/static/images/default_profile_pic.jpg' %}
                                            <img src="{{ proponent.profile_image.url }}" alt="profile_pic" class="user-pic-table img-fluid larger-img">
                                      {% else %}
                                        {% comment %} no {% endcomment %}
                                            <img src="{% static '/images/default_profile_pic.jpg' %}" class="img-fluid user-pic-table larger-img"> 
                                      {% endif %}
                                    </td>
                                    <td>
                                        {{ declined.get_full_name }}
                                    {% if user == declined %}
                                        <span class="badge bg-info ms-2">You</span>
                                    {% endif %}
                                </td>
                                    <td><span class="badge bg-danger">Declined</span></td>
                                    <td class="action-cell">
                                        {% if user == group_data.group.creator %}
                                        <span class="hint-button">Click row to show actions</span>
                                        <div class="action-buttons">
                                                <a href="{% url 'remove-member' group_data.group.id declined.id %}" class="btn btn-outline-danger btn-sm"
                                                    onclick="return confirm('Are you sure you want to remove this member?')">Remove Member</a>
                                            </div> 
                                            {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}

                            {% if user == group_data.group.creator and group_data.join_requests %}
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Join Group Requests</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for request_user in group_data.join_requests %}
                                            <tr onclick="toggleActions(this)">
                                                <td>{{ request_user.get_full_name }}</td>
                                                <td class="action-cell">
                                                    <span class="hint-button">Click row to show actions</span>
                                                    <div class="action-buttons">
                                                        <a href="{% url 'accept-join-request' group_data.group.id request_user.id %}" class="btn btn-outline-success btn-sm">Accept</a>
                                                        <a href="{% url 'decline-join-request' group_data.group.id request_user.id %}" class="btn btn-outline-danger btn-sm">Decline</a>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            {% endif %}
                                
                        </tbody>
                    </table>

                    {% if user == group_data.group.creator and not group_data.group.approved %}
                        <div class="mt-3">
                            {% if group_data.current_proponents.count >= 1 and group_data.pending_proponents.count == 0 and group_data.declined_proponents.count == 0 %}
                                <a href="{% url 'finalize-group' group_data.group.id %}" class="btn btn-outline-success btn-sm" 
                                    onclick="return confirm('Are you sure you want to Create Group with the current members? This action cannot be undone.')">
                                    Create Group with Current Members
                                </a>
                            {% endif %}
                            
                              <!-- Only allow inviting more members if the total members are less than max_proponents -->
                            {% if group_data.total_members < group_data.max_proponents %}
                                <a href="{% url 'invite-more-members' group_data.group.id %}" class="btn btn-outline-primary btn-sm"
                                    onclick="return confirm('Are you sure you want to invite more members to this group?')">
                                Invite More Members
                                </a>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
            <hr>
        {% endfor %}
    {% endif %}
{% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Handle clicking a hint button to show actions
        document.querySelectorAll('.hint-button').forEach((hintButton) => {
            hintButton.addEventListener('click', function (event) {
                // Prevent the event from propagating to the document click handler
                event.stopPropagation();
    
                // Hide all other action buttons and show all hint buttons
                document.querySelectorAll('.action-buttons').forEach((btns) => btns.style.display = 'none');
                document.querySelectorAll('.hint-button').forEach((btn) => btn.style.display = 'inline');
    
                // Show the action buttons for the clicked row and hide the hint button
                const row = hintButton.closest('tr');
                const actionButtons = row.querySelector('.action-buttons');
    
                hintButton.style.display = 'none';
                if (actionButtons) actionButtons.style.display = 'block';
            });
        });
    
        // Handle clicking outside of rows to hide all action buttons
        document.addEventListener('click', function (event) {
            // Hide all action buttons and reset hint buttons
            document.querySelectorAll('.action-buttons').forEach((btns) => btns.style.display = 'none');
            document.querySelectorAll('.hint-button').forEach((btn) => btn.style.display = 'inline');
        });
    
        // Prevent row click from triggering when clicking action buttons
        document.querySelectorAll('.action-buttons a').forEach((actionLink) => {
            actionLink.addEventListener('click', function (event) {
                event.stopPropagation();
            });
        });
    });
    
</script>

{% endblock %}