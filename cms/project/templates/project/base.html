{% load static %}

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="fonts/remixicon.css">
    <link rel="stylesheet" href="{% static 'images/default_profile_pic.jpg' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'images/user.jpg' %}">
    <link rel="stylesheet" href="{% static 'css/notification.css' %}">
    <link rel="stylesheet" href="{% static 'css/free_sched_style.css' %}">
    
    <!-- ===== ===== Custom Css ===== ===== -->
    <link rel="stylesheet" href="{% static 'profile_style.css' %}">
    <link rel="stylesheet" href="{% static 'responsive.css' %}">

    <!-- ===== ===== Remix Font Icons Cdn ===== ===== -->
    <link rel="stylesheet" href="fonts/remixicon.css">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    
    <script src="{% static 'js/custom.js' %}"></script>
    <script src="{% static 'js/notification.js' %}"></script>
    
    <title>Senior Project App</title>
  
    {% block styles %}{% endblock %}

    
  </head>
  <body class="body">
    <div class="wrapper">
      <div class="top_navbar">
        <div class="hamburger">
           <div class="hamburger__inner">
             <div class="one"></div>
             <div class="two"></div>
             <div class="three"></div>
           </div>
        </div>
        <div class="menu"> <!-- hero -->
          <div class="logo">
            <a href="{% url 'home' %}" style="text-decoration: none; color: inherit;"> &lt;/SP&gt; Management App </a>
          </div>
          {% if user.is_authenticated%}

            <div class="right_menu">
                <ul>
                
                <li>
                  <a href="#" id="notificationsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" onclick="ToggleMenuNotif(event)">
                    <i class="fas fa-bell icon icon-margin"></i>
                    <span class="notification-dropdown-badge" id="notification-count">0</span> Notifications
                  </a>
                  <ul class="dropdown-menu notification-dropdown text-start" aria-labelledby="notificationsDropdown" id="notifDropdown">
                    <li>
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="dropdown-header mb-2">
                          <span> Notifications </span>
                        </div>
                      </div>
                    </li>
                    <div id="notification-list">
                      <!-- Notifications will be dynamically inserted here -->
                          <li class="dropdown-item text-muted">No notifications at the moment.</li>
                    </div>
                    <li>
                      <div class="dropdown-footer text-center">
                        <a href="{% url 'notifications' %}" class="dropdown-item text-primary">See All Notifications</a>
                      </div>
                    </li>
                  </ul>
                </li>
                
              {% comment %}                 
                  <li> <a href="#">Features</a> </li>
                  <li> <a href="#">About</a> </li>
                  <li> <a href="#">Contact</a> </li> {% endcomment %}
                  
                    {% comment %} 
                  <li><i class="fas fa-user"></i>
                    <div class="">
                      <div class="">Profile</div>
                      <div class="dd_item">Change Password</div>
                      <div class="dd_item"><a href="{% url 'logout' %}" style="text-decoration: none; color: inherit;"><i class="fas fa-sign-out-alt"></i> Logout</a></div>
                    </div>
                  </li> {% endcomment %}
                </ul>
                  <div><span class="user-info-header" onclick="toggleMenu()">
                    {% if user.profile_image and user.profile_image.url != '/media/static/images/default_profile_pic.jpg' %}
                      {% comment %} yes {% endcomment %}
                      {% comment %} {{ user.profile_image.url }} {% endcomment %}
                      <img src="{{ user.profile_image.url }}" alt="profile_pic" class="user-pic img-fluid">
                    {% else %}
                      {% comment %} no {% endcomment %}
                      <img src="{% static '/images/default_profile_pic.jpg' %}" class="img-fluid user-pic"> 
                    {% endif %}
                    
                    <h5> {{ request.user.first_name }} {{ request.user.last_name }}</h5></span></div>    
                  <div class="sub-menu-wrap" id="subMenu"> 
                    <div class="sub-menu">
                      <div class="user-info"> 
                        
                        {% if user.profile_image and user.profile_image.url != '/media/static/images/default_profile_pic.jpg' %}
                          <img src="{{ user.profile_image.url }}" alt="profile_pic" class="user-pic">
                        {% else %}
                        <img src="{% static '/images/default_profile_pic.jpg' %}" class="user-pic img-fluid"> 
                        {% endif %}
                          
                        <h5> {{ request.user.first_name }} {{ request.user.last_name }}</h5>
                        
                      </div> 
                      <hr>
                      <a href="#" class="sub-menu-link">
                        <i class="material-icons">person</i>
                        <p>Edit Profile</p>
                        <span class="material-icons">chevron_right</span>
                      </a>
                      
                      <a href="#" class="sub-menu-link">
                        <i class="material-icons">settings</i>
                        <p>Settings and Privacy</p>
                        <span class="material-icons">chevron_right</span>
                      </a>
                      
                      <a href="{% url 'logout' %}" class="sub-menu-link">
                        <i class="material-icons">logout</i>
                        <p>Logout</p>
                        <span class="material-icons">chevron_right</span>
                      </a>

                    </div>
                  </div>
              </div>
          {% endif %}
        </div>
        </div>
      </div>
    
    {% comment %} <div class="d-flex justify-content-between align-items-center">
      {% include 'project/navbar.html' %} {% endcomment %}

      {% comment %} {% if user.is_authenticated %}
        <div class="usecdr-designation d-flex align-items-center p-2 bg-light rounded shadow-sm position-fixed bottom-0 end-0 m-3">
          <span class="me-2 fw-bold">Logged in as:</span>
          <span>{{ user.get_full_name }}</span>
          
          {% if user.get_role_display == "Coordinator" and not user.is_current_coordinator %}
              <span class="text-danger ms-2">(Former Coordinator)</span>
          {% else %}
              <span class="text-muted ms-2">({{ user.get_role_display }})</span>
          {% endif %}
            
        </div>
      {% endif %} {% endcomment %}
    </div> 
    
      <div class="main_container">
            <!-- Include the sidebar here -->
            <div class=sidebar> 
                {% include 'project/sidebar.html' %}
              <div> 

      {% if messages %}
        <div class="alert-container">
          {% for message in messages %}
            <div class="alert alert-dismissible fade show {% if message.tags %}alert-{{ message.tags }}{% endif %}" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div> 
      {% endif %}
    
      <div class="block_container" style="color: #000;">
        {% block content %} <!-- content of all web pages go -->
        {% endblock %}
    </div>

     </div> 
        <br/> 
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    
    {% csrf_token %}
    
    <script src="{% static 'js/notifications.js' %}"></script>


    <script>
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      function ToggleMenuNotif(event) {
        event.preventDefault(); // Prevent the default link behavior
        
        const dropdown = document.getElementById('notifDropdown'); // The dropdown menu element
        dropdown.classList.toggle('open-menu'); // Toggle the 'open-menu' class to show or hide the dropdown
      }
      
      let subMenu = document.getElementById("subMenu"); 
      
      function toggleMenu(){
        subMenu.classList.toggle("open-menu"); 
      } 

      $(document).ready(function() {
        $(".profile_info").hide();
        // Initial setup - collapse the sidebar when the page loads
        $(".sidebar").css("width", "80px"); // Collapse sidebar width initially
        $(".profile_info, .sidebar-link-text, .sidebar-menu-text").hide(); // Hide text initially
        $(".block_container").css("margin-left", "50px");
        $(".profile").css("margin-bottom", "20px")
        $(".menu-label").css("margin-top", "0px")
          // Hide sidebar scrollbar
        $(".sidebar").addClass("collapsed");


        let subMenu = document.getElementById("subMenu"); 

        function toggleMenu(){
          subMenu.classList.toggle("open-menu")
        }
        
        // Toggle class on hamburger click (optional, manual toggle)
        $(".hamburger .hamburger__inner").click(function() {
          $(".wrapper").toggleClass("active");
          if ($(".wrapper").hasClass("active")) {
            // Collapse sidebar - hide text content
            $(".sidebar").css("width", "80px");
            $(".profile_info").fadeOut(200);
            $(".sidebar-link-text").fadeOut(200);
            $(".sidebar-menu-text").fadeOut(200);
            $(".block_container").css("margin-left", "50px");
            $(".profile").css("margin-bottom", "60px")
                 // Hide sidebar scrollbar
            $(".sidebar").addClass("collapsed");
          } else {
            // Expand sidebar - show text content
            $(".sidebar").css("width", "300px");
            $(".profile_info").fadeIn(200);
            $(".sidebar-link-text").fadeIn(200);
            $(".sidebar-menu-text").fadeIn(200);
            $(".block_container").css("margin-left", "240px");
            $(".profile").css("margin-bottom", "20px")
             // Show sidebar scrollbar
            $(".sidebar").removeClass("collapsed");
          }
        });
    
        // Hover to expand and collapse sidebar
        $(".sidebar").hover(
          function() {
            // When the sidebar is hovered over, expand it
            $(".wrapper").removeClass("active"); // Expand sidebar
            $(".sidebar").css("width", "300px");
            $(".profile_info").fadeIn(200);
            $(".sidebar-link-text").fadeIn(200);
            $(".sidebar-menu-text").fadeIn(200);
            $(".block_container").css("margin-left", "240px");
            $(".profile").css("margin-bottom", "20px") 
             // Show sidebar scrollbar
            $(".sidebar").removeClass("collapsed");
            // Show dropdown arrows
          },
          function() {
            // When the hover is removed, collapse it
            if (!$(".wrapper").hasClass("active")) {
              $(".wrapper").addClass("active"); // Collapse sidebar
              $(".sidebar").css("width", "80px");
              $(".profile_info").fadeOut(200);
              $(".sidebar-link-text").fadeOut(200);
              $(".sidebar-menu-text").fadeOut(200);
              $(".block_container").css("margin-left", "50px");
              $(".profile").css("margin-bottom", "60px")
              // Hide dropdown arrows when collapsed
                // Hide sidebar scrollbar
              $(".sidebar").addClass("collapsed");
              }
          }
          
        );
        // Optional: Handle the dropdown toggle
      });

      
       // Function to toggle the read/unread status of a notification
      function toggleReadStatus(notificationId) {
        fetch(`/mark_read_unread/${notificationId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,  // Ensure the CSRF token is included
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Update the UI dynamically instead of reloading the page
                const notificationItem = document.querySelector(`[data-id='${notificationId}']`).closest('.notif-dropdown-item');
                const markButton = notificationItem.querySelector('.mark-read-unread');
                // Toggle the class based on the response
                if (data.is_read) {
                    notificationItem.classList.remove('unread');
                    notificationItem.classList.add('read');
                    markButton.textContent = 'Mark as Unread';
                } else {
                    notificationItem.classList.remove('read');
                    notificationItem.classList.add('unread');
                    markButton.textContent = 'Mark as Read';
                }
            }
        })
        .catch(error => console.error('Error:', error));
      }

      // Function to delete a notification
      function deleteNotification(notificationId) {
        fetch(`/delete_notification/${notificationId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken,  // Ensure the CSRF token is included
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Remove the notification from the UI dynamically
                const notificationItem = document.querySelector(`[data-id='${notificationId}']`).closest('.notif-dropdown-item');
                notificationItem.remove();  // Remove the notification item from the DOM
            }
        })
        .catch(error => console.error('Error:', error));
      }
      // Render notifications and attach event listeners
      fetch('/notifications_api/')
      .then(response => response.json())
      .then(data => {
        const notificationList = document.getElementById('notification-list');
        notificationList.innerHTML = ''; // Clear existing notifications
        
        if (data.notifications.length === 0) {
          notificationList.innerHTML = '<li class="dropdown-item text-muted">No notifications at the moment.</li>';
        } else {
          data.notifications.forEach(notification => {
            const item = document.createElement('li');
            item.classList.add('notif-dropdown-item');
            item.setAttribute('data-id', notification.id);  // Set the notification ID as a data attribute
            item.setAttribute('data-url', notification.redirect_url); // Add redirect URL


            // Apply the 'unread' class if the notification is not read
            if (!notification.is_read) {
              item.classList.add('unread');
            }

            // Build the notification content
            item.innerHTML = `
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong>${notification.message}</strong>
                  ${notification.group ? `<div>Group: ${notification.group}</div>` : ''}
                  ${notification.sender ? `<div>From: ${notification.sender}</div>` : ''}
                  ${notification.verdict ? `<div>"${notification.verdict}"</div>` : ''}
                  <div class="text-muted small">${notification.created_at}</div>
                </div>

                <!-- Options icon (three dots) on the right side -->
                <button class="btn btn-link p-0" type="button" data-bs-toggle="dropdown" aria-expanded="false" onclick="toggleDropdown(event)">
                  <i class="fa-solid fa-ellipsis-vertical"></i>
                </button>

                <!-- Dropdown menu -->
                <ul class="notif-dropdown-menu dropdown-menu">
                  <li><button class="dropdown-item mark-read-unread" data-id="${notification.id}">${notification.is_read ? 'Mark as Unread' : 'Mark as Read'}</button></li>
                  <li><button class="dropdown-item delete-notification" data-id="${notification.id}">Delete</button></li>
                </ul>
              </div>
            `;

            
            // Event listener for Mark as Read/Unread
            item.querySelector('.mark-read-unread').addEventListener('click', function(e) {
              e.stopPropagation();  // Prevent dropdown from closing
              const notificationId = e.target.getAttribute('data-id'); // Get the notification ID from data-id attribute
              if (notificationId) {
                toggleReadStatus(notificationId);  // Pass the notification ID to the function
              }
            });

            // Event listener for Delete
            item.querySelector('.delete-notification').addEventListener('click', function(e) {
              e.stopPropagation();  // Prevent dropdown from closing
              const notificationId = e.target.getAttribute('data-id'); // Get the notification ID from data-id attribute
              if (notificationId) {
                deleteNotification(notificationId);  // Pass the notification ID to the function
              }
            });

            notificationList.appendChild(item);
          });
           // Attach event listeners for redirection
          document.querySelectorAll('.notif-dropdown-item').forEach(function(item) {
            item.addEventListener('click', function() {
              const redirectUrl = this.getAttribute('data-url');
              if (redirectUrl) {
                window.location.href = redirectUrl; // Redirect to the URL
              }
            });
          });

        }

        // Update the unread notification count
        document.getElementById('notification-count').textContent = data.unread_count;
      })
      .catch(error => console.error('Error loading notifications:', error));

      // Function to toggle the dropdown visibility
        function toggleDropdown(event) {
          event.stopPropagation(); // Prevent the click event from propagating to the parent notification item

          // Close all other dropdown menus
          document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
            menu.classList.remove('show');
          });

          // Toggle visibility of the current dropdown menu
          const button = event.target.closest('button');
          const dropdownMenu = button.nextElementSibling; // Get the associated dropdown menu

          const isVisible = dropdownMenu.classList.contains('show');
          if (!isVisible) {
            dropdownMenu.classList.add('show'); // Show the menu
          } else {
            dropdownMenu.classList.remove('show'); // Hide the menu
          }
        }

        // Close dropdowns when clicking anywhere else on the page
        document.addEventListener('click', () => {
          document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
            menu.classList.remove('show');
          });
        });

        
    </script>
  </body>
</html>

