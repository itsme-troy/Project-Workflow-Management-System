    {% extends 'project/base.html' %}
    {% load custom_filters %}
    {% load static %}
    

    {% block content %}
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="text-center mb-4">Your Notifications</h1>
            
            <div class="dropdown-page-notif-settings">
                <button class="btn btn-secondary btn-sm" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fa-solid fa-ellipsis-vertical fa-2x"></i>
                </button>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    <li>
                        <a class="dropdown-item" href="#" id="mark-all-read-btn">
                            <span class="material-icons" style="margin-right:2px">mark_email_read</span> Mark All as Read
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" id="delete-all-btn">
                            <span class="material-icons" style="margin-right:2px">delete</span> Delete All Notifications
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <hr class="my-4">
            <!-- Mark All as Read Button -->
            <!-- Buttons container aligned in a row -->
                <!-- Filter buttons in the center -->
                <div class="mb-3">
                    <button class="btn btn-primary filter-btn" id="show-all-btn">All Notifications</button>
                    <button class="btn btn-secondary filter-btn" id="show-unread-btn">Unread Notifications</button>
                </div>
        
                <!-- Mark All as Read Button on the right -->

        {% if not notifications %}
            <center>
                <div class="alert custom-error-alert no-timeout-alert" role="alert">
                    <h4> No Notifications at the moment. </h4>
                </div>
            </center>
        {% else %}
            <ul class="list-group" id="notification-list">
                {% for notification in notifications %}
                    <li class="notification-item {% if not notification.is_read %}unread{% else %}read{% endif %}" data-url="{{ notification.redirect_url }}">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>{{ notification.get_notification_type_display }}:</strong> {{ notification.message }}
                            {% if notification.verdict %}
                                <span class="badge badge-{{ notification.verdict|lower|slugify_filter }}">
                                    {{ notification.verdict|capfirst }}
                                </span>
                            {% endif %}
                            <div class="text-muted text-end">{{ notification.created_at|date:"M j, Y g:i A" }}</div>
                            <div class="dropdown-page-notif-settings">
                                <button class="btn btn-link p-0" type="button" aria-label="More options" data-bs-toggle="dropdown" data-bs-placement="top">
                                    <i class="fas fa-cog fa-1.5x"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <button class="dropdown-item mark-read-unread" data-id="{{ notification.id }}">
                                            {% if notification.is_read %}
                                                Mark as Unread
                                            {% else %}
                                                Mark as Read
                                            {% endif %}
                                        </button>
                                    </li>
                                    <li>
                                        <button class="dropdown-item delete-notification" data-id="{{ notification.id }}">Delete</button>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </li>
                {% endfor %}
            </ul>
            <div id="no-unread-message" class="alert alert-info" style="display:none;" role="alert">
                No notifications at the moment.
            </div>
        {% endif %}



    <script>
        
        document.addEventListener('DOMContentLoaded', function() {

            
            // Get all notification items
            const notificationsList = document.querySelectorAll('.notification-item');
            
            // Get the "No Unread Notifications" message container
            const noUnreadMessage = document.getElementById('no-unread-message');
        
            // Button references
            const showAllBtn = document.getElementById('show-all-btn');
            const showUnreadBtn = document.getElementById('show-unread-btn');
            
            // Function to show only unread notifications
            function showUnreadNotifications() {
                let unreadFound = false;  // Track if there are unread notifications

                // Iterate through all notifications
                notificationsList.forEach(function(notification) {
                    if (notification.classList.contains('unread')) {
                        notification.style.display = 'block';  // Show unread notifications
                        unreadFound = true;  // Set the flag to true if unread notification is found
                    } else {
                        notification.style.display = 'none';  // Hide read notifications
                    }
                });

                // Show or hide the "No unread notifications" message based on unreadFound
                if (unreadFound) {
                    noUnreadMessage.style.display = 'none';  // Hide the message if unread notifications exist
                } else {
                    noUnreadMessage.style.display = 'block'; // Show the message if no unread notifications
                }
            }
        
            // Function to show all notifications
            function showAllNotifications() {
                notificationsList.forEach(function(notification) {
                    notification.style.display = 'block';  // Show all notifications
                });

                // Hide the "No unread notifications" message when showing all notifications
                noUnreadMessage.style.display = 'none';
            }

            // Event listener for "All Notifications" button
            showAllBtn.addEventListener('click', function() {
                showAllNotifications();  // Show all notifications when clicked
            });

            // Event listener for "Unread Notifications" button
            showUnreadBtn.addEventListener('click', function() {
                showUnreadNotifications();  // Show only unread notifications when clicked
            });

            // Initially show all notifications
            showAllNotifications();

            // Attach event listener to each notification item for redirection
            document.querySelectorAll('.notification-item').forEach(function(item) {
                item.addEventListener('click', function() {
                    const redirectUrl = this.getAttribute('data-url');
                    if (redirectUrl) {
                        window.location.href = redirectUrl; // Redirect to the URL
                    }
                });
            });
            
            // Event listener for "Mark All as Read" button
            const markAllReadBtn = document.getElementById('mark-all-read-btn');
            markAllReadBtn.addEventListener('click', function() {
                const csrfToken = '{{ csrf_token }}';  // Make sure CSRF token is passed correctly

                // Send a request to mark all notifications as read
                fetch('/mark_all_read/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,  // CSRF token
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Update all notifications to 'read' class
                        notificationsList.forEach(function(notification) {
                            notification.classList.remove('unread');
                            notification.classList.add('read');
                        });
                    } else {
                        alert('Error marking all notifications as read');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while marking all notifications as read.');
                });
            });


            // Attach event listener for Mark Read/Unread functionality
            document.querySelectorAll('.mark-read-unread').forEach(function(button) {
                button.addEventListener('click', function(event) {
                    event.stopPropagation(); // Prevent the click from propagating
        
                    const notificationId = this.getAttribute('data-id');
                    const csrfToken = '{{ csrf_token }}'; // Make sure CSRF token is passed correctly
        
                    // Send a request to mark the notification as read/unread
                    fetch(`/mark_read_unread/${notificationId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,  // CSRF token
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            const notificationItem = this.closest('.notification-item');
                            
                            // Toggle the read/unread class
                            if (data.is_read) {
                                notificationItem.classList.remove('unread');
                                notificationItem.classList.add('read');
                                this.textContent = 'Mark as Unread';  // Update the button text
                            } else {
                                notificationItem.classList.remove('read');
                                notificationItem.classList.add('unread');
                                this.textContent = 'Mark as Read';  // Update the button text
                            }
                            // Close the dropdown after action
                            const dropdownMenu = this.closest('.dropdown-menu');
                            if (dropdownMenu) {
                                dropdownMenu.classList.remove('show'); // Close the dropdown menu
                            }

                            // Remove the 'with-dropdown' class to restore the original size
                            notificationItem.classList.remove('with-dropdown');
                            

                        } else {
                            alert('Error marking notification as read/unread');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while toggling the read/unread status.');
                    });
                });
            });
        
            // Attach event listener to each delete button
            document.querySelectorAll('.delete-notification').forEach(function(button) {
                button.addEventListener('click', function(event) {
                    event.stopPropagation(); // Prevent the event from bubbling up
                    const notificationId = this.getAttribute('data-id');
            
                    // Make sure CSRF token is correctly passed
                    const csrfToken = '{{ csrf_token }}';
            
                    // Send DELETE request to the server
                    fetch(`/delete_notification/${notificationId}/`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': csrfToken,  // CSRF token
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            this.closest('.notification-item').remove();
                        } else {
                            alert('Error deleting notification: ' + data.message || 'Unknown error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while deleting the notification.');
                    });
                });
            });
        

            // Stop the event propagation when clicking on the cog icon to prevent it from closing immediately
            document.querySelectorAll('.dropdown-page-notif-settings button').forEach(function(button) {
                button.addEventListener('click', function(event) {
                    event.stopPropagation(); // Prevent the event from propagating to the notification item
                    
                    const notificationItem = this.closest('.notification-item'); // Get the parent notification item
                    const dropdownMenu = this.nextElementSibling;  // This gets the associated <ul> dropdown
                    
                    // Toggle the 'show' class to display or hide the dropdown
                    dropdownMenu.classList.toggle('show');  
                    
                    // Toggle the 'with-dropdown' class to increase the height of the notification item
                    notificationItem.classList.toggle('with-dropdown');
                });
            });
            // Close the dropdown if clicked outside of the notification item or the dropdown
            document.addEventListener('click', function(event) {
                document.querySelectorAll('.dropdown-menu').forEach(function(dropdown) {
                    if (!event.target.closest('.dropdown-page-notif-settings')) {
                        dropdown.classList.remove('show'); // Hide the dropdown
                        const notificationItem = dropdown.closest('.notification-item');
                        notificationItem.classList.remove('with-dropdown'); // Reset the notification item's height
                    }
                });
            });
                
            // Close the dropdown if clicked outside of the notification item
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.notification-item')) {
                    document.querySelectorAll('.dropdown-menu').forEach(function(dropdown) {
                        dropdown.classList.remove('show');
                    });
                }
            });

            // Button reference for deleting all notifications
            const deleteAllBtn = document.getElementById('delete-all-btn');
            
        
            // Function to delete all notifications
            function deleteAllNotifications() {
                const csrfToken = '{{ csrf_token }}'; // Get CSRF token from the template

                // Send DELETE request to the server to delete all notifications
                fetch('/delete_all_notifications/', {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // If successful, remove all notifications from the UI
                        notificationsList.forEach(function(notification) {
                            notification.remove();  // Remove each notification item from the DOM
                        });

                        // Optionally, show a success message
                        alert('All notifications deleted successfully');
                    } else {
                        alert('Error deleting all notifications');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting all notifications.');
                });
            }

            // Event listener for "Delete All Notifications" button
            deleteAllBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to delete all notifications?')) {
                    deleteAllNotifications();  // Call the function to delete all notifications
                }
            });

        });
        
    </script>
    {% endblock %}
