{% extends 'project/base.html' %}
{% load custom_filters %}
{% load static %}

{% block extra_head %}
<style>
    body {
        max-width: 600px;      /* Set the maximum width of the body */
        margin: 0 auto;         /* Center the body content */
    }
</style>
{% endblock %}

{% block content %}
    <h1 class="text-center">Your Notifications</h1>
    <hr class="my-4">

    {% if not notifications %}
        <center>
            <div class="alert custom-error-alert no-timeout-alert" role="alert">
                <h4> No Notifications at the moment. </h4> 
            </div> 
        </center>
    {% else %}
        {% if notifications %}
            <ul class="list-group">
                {% for notification in notifications %}
                
                <li class="notification-item {% if not notification.is_read %}unread{% else %}read{% endif %}" data-url="{{ notification.redirect_url }}">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>{{ notification.get_notification_type_display }}:</strong> {{ notification.message }}
                
                        {% if notification.verdict %}
                            <span class="badge badge-{{ notification.verdict|lower|slugify_filter }}">
                                {{ notification.verdict|capfirst }}
                            </span>
                        {% endif %}
                
                        <div class="text-muted text-end float-end">{{ notification.created_at|date:"M j, Y g:i A" }}</div>
                        
                        <div class="dropdown-page-notif-settings">
                            <button class="btn btn-link p-0" type="button" aria-label="More options" data-bs-toggle="dropdown" data-bs-placement="top">
                                <i class="fas fa-cog"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <button class="dropdown-item mark-read-unread" data-id="{{ notification.id }}">
                                        {% if notification.is_read %}
                                            Mark as Unread
                                        {% else %}
                                            Mark as Read
                                        {% endif %}
                                    </button>
                                </li>
                                <li>
                                    <button class="dropdown-item delete-notification" data-id="{{ notification.id }}">Delete</button>
                                </li>
                            </ul>
                        </div>
                
                    </div>
                </li>
                
                {% endfor %}
            </ul>
        {% endif %}
    {% endif %}

<script>
    
    document.addEventListener('DOMContentLoaded', function() {
        // Attach event listener to each notification item for redirection
        document.querySelectorAll('.notification-item').forEach(function(item) {
            item.addEventListener('click', function() {
                const redirectUrl = this.getAttribute('data-url');
                if (redirectUrl) {
                    window.location.href = redirectUrl; // Redirect to the URL
                }
            });
        });
    
        
        // Attach event listener for Mark Read/Unread functionality
        document.querySelectorAll('.mark-read-unread').forEach(function(button) {
            button.addEventListener('click', function(event) {
                event.stopPropagation(); // Prevent the click from propagating
    
                const notificationId = this.getAttribute('data-id');
                const csrfToken = '{{ csrf_token }}'; // Make sure CSRF token is passed correctly
    
                // Send a request to mark the notification as read/unread
                fetch(`/mark_read_unread/${notificationId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,  // CSRF token
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const notificationItem = this.closest('.notification-item');
                        
                        // Toggle the read/unread class
                        if (data.is_read) {
                            notificationItem.classList.remove('unread');
                            notificationItem.classList.add('read');
                            this.textContent = 'Mark as Unread';  // Update the button text
                        } else {
                            notificationItem.classList.remove('read');
                            notificationItem.classList.add('unread');
                            this.textContent = 'Mark as Read';  // Update the button text
                        }
                    } else {
                        alert('Error marking notification as read/unread');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while toggling the read/unread status.');
                });
            });
        });
    
        // Attach event listener to each delete button
        document.querySelectorAll('.delete-notification').forEach(function(button) {
            button.addEventListener('click', function(event) {
                event.stopPropagation(); // Prevent the event from bubbling up
                const notificationId = this.getAttribute('data-id');
        
                // Make sure CSRF token is correctly passed
                const csrfToken = '{{ csrf_token }}';
        
                // Send DELETE request to the server
                fetch(`/delete_notification/${notificationId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrfToken,  // CSRF token
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        this.closest('.notification-item').remove();
                    } else {
                        alert('Error deleting notification: ' + data.message || 'Unknown error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the notification.');
                });
            });
        });
    

         // Stop the event propagation when clicking on the cog icon to prevent it from closing immediately
        document.querySelectorAll('.dropdown-page-notif-settings button').forEach(function(button) {
            button.addEventListener('click', function(event) {
                event.stopPropagation(); // Prevent the event from propagating to the notification item
                
                const notificationItem = this.closest('.notification-item'); // Get the parent notification item
                const dropdownMenu = this.nextElementSibling;  // This gets the associated <ul> dropdown
                
                // Toggle the 'show' class to display or hide the dropdown
                dropdownMenu.classList.toggle('show');  
                
                // Toggle the 'with-dropdown' class to increase the height of the notification item
                notificationItem.classList.toggle('with-dropdown');
            });
        });
        // Close the dropdown if clicked outside of the notification item or the dropdown
        document.addEventListener('click', function(event) {
            document.querySelectorAll('.dropdown-menu').forEach(function(dropdown) {
                if (!event.target.closest('.dropdown-page-notif-settings')) {
                    dropdown.classList.remove('show'); // Hide the dropdown
                    const notificationItem = dropdown.closest('.notification-item');
                    notificationItem.classList.remove('with-dropdown'); // Reset the notification item's height
                }
            });
        });
            
        // Close the dropdown if clicked outside of the notification item
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.notification-item')) {
                document.querySelectorAll('.dropdown-menu').forEach(function(dropdown) {
                    dropdown.classList.remove('show');
                });
            }
        });
    });
    
</script>
{% endblock %}
