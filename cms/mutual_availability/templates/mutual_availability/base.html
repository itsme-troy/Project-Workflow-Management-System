{% extends 'project/base.html' %}
{% load static %}
{% load custom_filters %} 
{% block styles %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.css" />
    <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.34/moment-timezone-with-data.min.js"></script>
    
    <link rel="stylesheet" href="{% static  'css/mutual_availability.css' %}">
    <link rel="stylesheet" href="{% static 'free_schedule/css/free_sched.css' %}">
    <link rel="stylesheet" href="{% static 'free_schedule/css/style_calendar.css' %}">

    <!-- FullCalendar JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.js"></script>
    
    <!-- Custom JS -->
    <script src="{% static 'js/availability.js' %}"></script> 

{% endblock %}

{% block content %}  
    {{ block.super }}

    <script>

        function updateColor(facultyId) {
            const colorPicker = document.getElementById(`color-picker-${facultyId}`);
            const colorPreview = document.getElementById(`color-preview-${facultyId}`);
            const newColor = colorPicker.value;
            
            // Update the preview color locally
            colorPreview.style.backgroundColor = newColor;
        
            // Perform AJAX POST request to update the color in the database
            fetch("{% url 'update_faculty_color' %}", {  // Replace with the correct URL name
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",  // CSRF token for security
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    faculty_id: facultyId,
                    color: newColor
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log("Color updated successfully:", data.new_color);
                    alert("Color updated successfully!");
                    
                    // Refresh FullCalendar events to apply the updated color
                    $('#calendar').fullCalendar('refetchEvents');
                    
                    // Refresh the schedule dots list by updating the color of all dots related to this faculty
                    document.querySelectorAll(`#schedule-list-${facultyId} .schedule-dot`).forEach(dot => {
                        dot.style.backgroundColor = newColor;
                    });
        
                    refreshEventsList(); // Call refreshEventsList to update the list of events
                
                } else {
                    console.error("Error updating color:", data.error);
                    alert("Failed to update color. Please try again.");
                }
            })
            .catch(error => {
                console.error("AJAX error:", error);
                alert("An error occurred. Please try again.");
            });
        }
        
        
        // utility function in JavaScript to dynamically select a text color (black or white) 
        // based on the background color's brightness.
        function getContrastYIQ(hexColor) {
            if (!hexColor) return '#000000'; // Default to black if no color is provided
            hexColor = hexColor.replace('#', '');
            const r = parseInt(hexColor.substr(0, 2), 16);
            const g = parseInt(hexColor.substr(2, 2), 16);
            const b = parseInt(hexColor.substr(4, 2), 16);
            const yiq = (r * 299 + g * 587 + b * 114) / 1000;
            return yiq >= 128 ? '#000000' : '#FFFFFF'; // Return black for light colors and white for dark colors
        }

        function formatDate(date) {
            return moment(date).toISOString(); // Use ISO format
        }
        function refreshEventsList() {
            $.ajax({
                type: "GET",
                url: "{% url 'all_sched' %}",
                dataType: "json",
                success: function (data) {
                    const list = $('.list-group');
                    list.empty(); // Clear existing list
        
                    if (data && Object.keys(data).length > 0) {
                        Object.entries(data).forEach(([facultyId, info]) => {
                            const { faculty, schedules } = info;
        
                            // Create faculty item
                            const facultyItem = `
                                <li class="list-group-item">
                                    <div class="d-flex align-items-center">
                                        <span id="color-preview-${faculty.id}" 
                                              class="me-2 color-preview" 
                                              style="background-color: ${faculty.color || '#007BFF'};">
                                        </span>
                                        <strong>${faculty.first_name} ${faculty.last_name}</strong>
                                        <ul id="schedule-list-${faculty.id}" class="mt-2 ps-4">
                                            ${schedules.map(schedule => `
                                                <li>
                                                    <div class="schedule-dot" style="background-color: ${faculty.color || '#007BFF'};"></div>
                                                    From: ${moment(schedule.start).tz('Asia/Manila').format("MMM. D, YYYY h:mm A")}
                                                    To: ${moment(schedule.end).tz('Asia/Manila').format("MMM. D, YYYY h:mm A")}
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                </li>`;
                            
                            list.append(facultyItem);
                        });
                    } else {
                        list.append('<li class="list-group-item">No available schedules found.</li>');
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Error fetching events:", status, error);
                    alert('There was a problem fetching the events list!');
                }
            });
        }

        $(document).ready(function () {

            var calendar = $('#calendar').fullCalendar({
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'month,agendaWeek,agendaDay'
                },
                timezone: 'Asia/Manila', // Align with server timezone
                
                events: function(start, end, timezone, callback) {
                    // Get the selected project ID from the filter form
                    var project_id = $('#project').val();
                    
                    // Make an AJAX request to fetch events based on the selected project
                    $.ajax({
                        url: '{% url "all_sched" %}',  // Adjust to the correct URL pattern
                        data: {
                            'project': project_id,  // Send the selected project ID to the server
                        },
                        success: function(data) {
                            // Pass the data to FullCalendar
                            callback(data);
                        }
                    });
                },
                selectable: false,
                selectHelper: false,
                editable: false,
                eventLimit: false,
                //contentHeight: 'auto',
                //height: 'auto',
                defaultView: 'agendaWeek',
                  
                // This allows for removing events from the calendar and from the database.
                eventRender: function (event, element) {
                    const textColor = getContrastYIQ(event.color);
                    
                    var displayText = `
                        <div style="font-size: 12px; font-weight: bold;">
                            ${moment(event.start).tz('Asia/Manila').format('hh:mm A')} - ${moment(event.end).tz('Asia/Manila').format('hh:mm A')}
                        </div>
                        <div style="font-size: 12px; color: #333;">
                            ${event.faculty.first_name} ${event.faculty.last_name}
                        </div>
                    `;
                    element.find('.fc-content').html(displayText);
                    element.css({
                        'border': `2px solid ${event.color}`,
                        'background-color': event.color,
                        'color': textColor
                    });
                },
            }); // Update calendar events when the project filter is changed
            $('#filter-project-form').submit(function(e) {
                e.preventDefault();
                calendar.fullCalendar('refetchEvents'); // Refetch events with the selected project filter
                //refreshEventsList()
            });
        });
    </script>
{% endblock %}