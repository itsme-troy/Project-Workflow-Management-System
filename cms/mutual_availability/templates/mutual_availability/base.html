{% extends 'project/base.html' %}
{% load static %}
{% load custom_filters %} 
{% block styles %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.css" />
    <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.34/moment-timezone-with-data.min.js"></script>
    
    <link rel="stylesheet" href="{% static  'css/mutual_availability.css' %}"> 
    <link rel="stylesheet" href="{% static 'free_schedule/css/free_sched.css' %}">
    <link rel="stylesheet" href="{% static 'free_schedule/css/style_calendar.css' %}">

    <!-- FullCalendar JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.js"></script>
    
    <!-- Custom JS -->
    <script src="{% static 'js/availability.js' %}"></script> 

{% endblock %}

{% block content %}  
    {{ block.super }}

    <script>
        function updateColor(facultyId) {
            const colorPicker = document.getElementById(`color-picker-${facultyId}`);
            const colorPreview = document.getElementById(`color-preview-${facultyId}`);
            const newColor = colorPicker.value;
            
            // Update the preview color locally
            colorPreview.style.backgroundColor = newColor;
        
            // Perform AJAX POST request to update the color in the database
            fetch("{% url 'update_faculty_color' %}", {  // Replace with the correct URL name
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",  // CSRF token for security
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    faculty_id: facultyId,
                    color: newColor
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log("Color updated successfully:", data.new_color);
                    alert("Color updated successfully!");
                    
                    // Refresh FullCalendar events to apply the updated color
                    $('#calendar').fullCalendar('refetchEvents');
                    
                    // Refresh the schedule dots list by updating the color of all dots related to this faculty
                    document.querySelectorAll(`#schedule-list-${facultyId} .schedule-dot`).forEach(dot => {
                        dot.style.backgroundColor = newColor;
                    });
        
                    refreshEventsList(); // Call refreshEventsList to update the list of events
                
                } else {
                    console.error("Error updating color:", data.error);
                    alert("Failed to update color. Please try again.");
                }
            })
            .catch(error => {
                console.error("AJAX error:", error);
                alert("An error occurred. Please try again.");
            });
        }  
        // utility function in JavaScript to dynamically select a text color (black or white) 
        // based on the background color's brightness.
        function getContrastYIQ(hexColor) {
            if (!hexColor) return '#000000'; // Default to black if no color is provided
            hexColor = hexColor.replace('#', '');
            const r = parseInt(hexColor.substr(0, 2), 16);
            const g = parseInt(hexColor.substr(2, 2), 16);
            const b = parseInt(hexColor.substr(4, 2), 16);
            const yiq = (r * 299 + g * 587 + b * 114) / 1000;
            return yiq >= 128 ? '#000000' : '#FFFFFF'; // Return black for light colors and white for dark colors
        }

        function formatDate(date) {
            return moment(date).toISOString(); // Use ISO format
        }
        function refreshEventsList() {
            $.ajax({
                type: "GET",
                url: "{% url 'all_sched' %}",
                dataType: "json",
                success: function (data) {
                    const list = $('.list-group');
                    list.empty(); // Clear existing list
        
                    if (data && Object.keys(data).length > 0) {
                        Object.entries(data).forEach(([facultyId, info]) => {
                            const { faculty, schedules } = info;
        
                            // Create faculty item
                            const facultyItem = `
                                <li class="list-group-item">
                                    <div class="d-flex align-items-center">
                                        <span id="color-preview-${faculty.id}" 
                                              class="me-2 color-preview" 
                                              style="background-color: ${faculty.color || '#007BFF'};">
                                        </span>
                                        <strong>${faculty.first_name} ${faculty.last_name}</strong>
                                        <ul id="schedule-list-${faculty.id}" class="mt-2 ps-4">
                                            ${schedules.map(schedule => `
                                                <li>
                                                    <div class="schedule-dot" style="background-color: ${faculty.color || '#007BFF'};"></div>
                                                    From: ${moment(schedule.start).tz('Asia/Manila').format("MMM. D, YYYY h:mm A")}
                                                    To: ${moment(schedule.end).tz('Asia/Manila').format("MMM. D, YYYY h:mm A")}
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                </li>`;
                            
                            list.append(facultyItem);
                        });
                    } else {
                        list.append('<li class="list-group-item">No available schedules found.</li>');
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Error fetching events:", status, error);
                    alert('There was a problem fetching the events list!');
                }
            });
        }

        $(document).ready(function () {
             // Check if the user is the current coordinator
             const isCurrentCoordinator = {{ request.user.is_current_coordinator|yesno:"true,false" }};

             // Function to open the modal and set start and end times and project_id
             function openCreateScheduleModal(start = '', end = '',  project_id = '') {
 
                 if (!isCurrentCoordinator) {
                     alert('You do not have permission to create or edit schedules.');
                     return; // Prevent opening the modal if not a coordinator
                 }
 
                 // Set the start and end fields if provided
                 $('#schedule-start').val(start);
                 $('#schedule-end').val(end);

                   // Set the project ID in the modal (hidden input or visible field)
                $('#schedule-project').val(project_id);

 
                 // Reset other fields
                 $('#schedule-application').val('');
                 $('#schedule-color').val('#007bff');
         
                 // Open the modal 
                 $('#createDefenseScheduleModal').modal('show');
             }
         
             // Open modal without pre-filled dates when the "Create Schedule" button is clicked
                $('#create-defense-schedule-btn').on('click', function () {
                    const selectedProjectId = $('#project').val(); // Get selected project ID
                    openCreateScheduleModal('', '', selectedProjectId); // Pass project ID
                });
                
              // Handle form submission
            $('#create-defense-schedule-form').on('submit', function (e) {
                if (!isCurrentCoordinator) {
                    alert('You do not have permission to create or edit schedules.');
                    return; // Prevent opening the modal if not a coordinator
                }

                e.preventDefault(); // Prevent the default form submission
        
                // Get the CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
                // Serialize form data
                const formData = $(this).serialize();
        
                // Get the selected color
                const selectedColor = $('#schedule-color').val();
        
                // Send AJAX request
                $.ajax({
                    url: 'create_defense_sched', // URL for the view
                    type: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken // Include the CSRF token in the headers
                    },
                    data: formData + '&color=' + encodeURIComponent(selectedColor), // Append color to the serialized data
                    success: function (response) {
                        if (response.status === 'success') {
                            alert('Schedule created successfully!');
                            location.reload(); // Refresh the page to show the new schedule
                        } else {
                            alert(`Failed to create schedule: ${response.message}`);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error(xhr.responseText);
                        alert('An error occurred. Please try again.');
                    }
                });
            });
                // Retrieve the `view` URL parameter (either 'agendaDay' or 'agendaWeek')
            var urlParams = new URLSearchParams(window.location.search);
            var viewParam = urlParams.get('view') || 'agendaWeek'; // Default to 'agendaWeek' if no view is specified
            var startParam = urlParams.get('start');
            var endParam = urlParams.get('end');
       
            var calendar = $('#calendar').fullCalendar({
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'month,agendaWeek,agendaDay'
                },
                timezone: 'Asia/Manila', // Align with server timezone
                defaultView: viewParam,  // Set the default view based on the URL parameter

                events: function(start, end, timezone, callback) {
                    // Get the selected project ID from the filter form
                    var project_id = $('#project').val();
                    
                    // Make an AJAX request to fetch events based on the selected project
                    $.ajax({
                        url: '{% url "all_sched" %}',  // Adjust to the correct URL pattern
                        data: {
                            'project': project_id,  // Send the selected project ID to the server
                        },
                        success: function(data) {
                            // Pass the data to FullCalendar
                            callback(data);
                        }
                    });
                },
                selectable: true,
                selectHelper: false,
                editable: false,
                eventLimit: false,
                //contentHeight: 'auto',
                //height: 'auto',
                //defaultView: 'month',
                minTime: '06:00:00', // This line ensures that the calendar starts at 7 AM
                
                select: function (start, end, allDay) {

                    // Check the current view type (month, week, or day)
                    var currentView = calendar.fullCalendar('getView').type;
                    // Get the selected project ID
                    var project_id = $('#project').val(); // Get the selected filter (project ID)

                    // Declare variables for adjusted start and end times
                    var adjustedStart, adjustedEnd;
                
                     // If the current view is 'month', set the event as an all-day event
                    // If the current view is 'month', set the event as an all-day event
                    if (currentView === 'month') {
                        // Adjust start and end times for all-day events (12:00 AM to 11:59 PM)
                        var adjustedStart = start.clone().startOf('day'); // Start at 12:00 AM
                        var adjustedEnd = end.clone().subtract(1, 'seconds').endOf('day'); // End at 11:59 PM
                        // isAllDay = true;
                        // Open the modal with the adjusted start and end times
                        openCreateScheduleModal(adjustedStart.toISOString(), adjustedEnd.toISOString(), project_id);
                    } else {
                        // For other views (week, day), pass the original start and end times
                        openCreateScheduleModal(start.toISOString(), end.toISOString(), project_id);
                        // If the user selects an all-day event, pass it accordingly
                    } 
                    // Ensure end time is after start time
                    if (!adjustedEnd.isAfter(adjustedStart)) {
                        alert("End time must be after start time.");
                        return;
                    }

                },
                // This allows for removing events from the calendar and from the database.
                eventRender: function (event, element) {
                    const textColor = getContrastYIQ(event.color);
                    const facultyTextColor = getContrastYIQ(event.color); // Apply same contrast to faculty name text
                    
                    // Format faculty name
                    const facultyName = event.faculty 
                        ? `${event.faculty.first_name} ${event.faculty.last_name}` 
                        : "Unknown Faculty";
                
                    // Generate display text
                    var displayText = `
                        <div style="font-size: 12px; font-weight: bold; color: ${facultyTextColor};">
                            ${moment(event.start).tz('Asia/Manila').format('hh:mm A')} - ${moment(event.end).tz('Asia/Manila').format('hh:mm A')}
                        </div>
                        <div style="font-size: 12px; color: ${facultyTextColor};">
                            ${facultyName} <!-- Display faculty name -->
                        </div>
                    `;
                
                    // Update the event content and styles
                    element.find('.fc-content').html(displayText);
                    element.css({
                        'border': `2px solid ${event.color}`,
                        'background-color': event.color,
                        'color': textColor
                    });
                },
                
            }); // Update calendar events when the project filter is changed
            

            // Automatically open the correct view when the page loads, based on the URL
            if (startParam && endParam) {
                var startMoment = moment(startParam);
                var endMoment = moment(endParam);

                // Ensure calendar loads in the correct day and time range
                calendar.fullCalendar('gotoDate', startMoment);
                var highlightEvent = {
                    title: 'Common Schedule Highlight',
                    start: startMoment,
                    end: endMoment,
                    color: '#ffcc00', // Highlight color
                    rendering: 'background', // Background highlight
                    allDay: false
                };
                calendar.fullCalendar('renderEvent', highlightEvent, true);
            }

            // Handle common schedule list click events (redirecting to calendar with params)
            $('#common-schedule-list .stretched-link').on('click', function (e) {
                e.preventDefault();

                var start = $(this).data('start');
                var end = $(this).data('end');
                var selectedProjectId = $('#project').val(); // Get the selected project ID

               // Redirect with the correct start, end, view, and project parameters
                window.location.href = "{% url 'view-schedule' %}?start=" + start + "&end=" + end + "&view=agendaDay" + "&project=" + selectedProjectId;
            });

            // Update calendar events when the project filter is changed
            $('#project').on('change', function () {
                const selectedProjectId = $(this).val();
                $('#schedule-application').val(selectedProjectId);
            });
            
            $('#filter-project-form').submit(function (e) {
                e.preventDefault();
                calendar.fullCalendar('refetchEvents');
                const selectedProjectId = $('#project').val();
            
                // Update modal dropdown to show only related applications
                $('#schedule-application option').each(function () {
                    const optionValue = $(this).val();
                    $(this).toggle(selectedProjectId === '' || optionValue.startsWith(selectedProjectId));
                });
            
                $('#schedule-application').val(selectedProjectId); // Auto-select filtered project
            });
        });
    </script>
{% endblock %}