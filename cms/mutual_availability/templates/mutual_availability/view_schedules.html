{% extends 'mutual_availability/base.html' %}
{% load static %}
{% load custom_filters %}
{% load tz %}


{% block content %}
{{ block.super }}

<div class="faculty-schedule-template">

<div class="table-container" style="overflow-x: hidden; margin: 0px;"> 
{% if user.is_authenticated %}
    <div class="header-container">
        <h1 class="page-title">Faculty Schedule Management</h1>
        <div class="header-buttons">
            {% if request.user.is_current_coordinator %}
                    <button id="create-defense-schedule-btn" class="btn btn-success btn-sm">
                        <i class="fas fa-plus-circle icon" style="color: white;"></i> Create Schedule
                    </button>

                    <a href="{% url 'defense-schedule' %}" class="btn btn-primary btn-sm">
                        <i class="fas fa-calendar-alt icon icon-margin"></i> Defense Schedules
                    </a>

                    <a href="javascript:history.back()" class="btn btn-outline-secondary btn-sm"> <i class="fas fa-arrow-left"></i> </a>
             {% endif %}
        </div>
    </div>

    <div class="row w-100">        
    <div class="col-md-3">

    <section id="faculty-schedule" class="faculty-schedule-container mb-6 border p-3 rounded bg-light mb-3">
        <!-- Faculty Schedules -->
        <div class="header-container">
            <h4 class="page-title" style="text-transform:none; ">Faculty</h4>
            <div class="header-buttons">
                <button id="toggle-button" class="btn btn-sm btn-secondary">Minimize</button>
            </div>
        </div>
          
            <div id="faculty-content" class="faculty-content">
                <ul id="faculty-list-group" class="list-group">
                    {% for faculty, schedules in grouped_events.items %}
                        <li class="list-group-item mt-1">
                            <div class="d-flex align-items-center">
                                <!-- Color Circle -->
                                <span id="color-preview-{{ faculty.id }}" 
                                    class="me-2 color-preview" 
                                    style="background-color: {{ faculty.color }};">
                                </span>
                                    <!-- Faculty Name -->
                                    <strong>{{ faculty.first_name }} {{ faculty.last_name }}</strong>

                                    <!-- Display Role Badge -->
                                    {% if faculty in faculty_roles %}
                                        <span class="badge ms-4 {% if faculty_roles|get_item:faculty == 'panelist' %}bg-primary{% elif faculty_roles|get_item:faculty == 'adviser' %}bg-success{% endif %}">
                                            {% if faculty_roles|get_item:faculty == 'panelist' %} Panelist {% elif faculty_roles|get_item:faculty == 'adviser' %} Adviser {% endif %}
                                        </span>
                                    {% endif %}

                                <!-- Expand/Collapse Icon -->
                                <i id="toggle-icon-{{ faculty.id }}" 
                                class="fas fa-chevron-down ms-2" 
                                style="cursor: pointer;" 
                                onclick="toggleSchedules({{ faculty.id }})">
                                </i>

                                <!-- Settings Icon and Color Picker (Positioned to the Right) -->
                                <div class="ms-auto d-flex align-items-center" style="position: relative;">
                                    <!-- Cog Icon -->
                                    <i id="cog-icon-{{ faculty.id }}" 
                                        class="fas fa-cog me-2" 
                                        style="cursor: pointer;" 
                                        onclick="toggleColorPicker({{ faculty.id }})">
                                    </i>

                                    <!-- Color Picker Dropdown (Initially Hidden) -->
                                    <div id="color-picker-dropdown-{{ faculty.id }}" 
                                    class="dropdown-menu dropdown-menu-end p-3 text-center" 
                                    style="display: none; min-width: 200px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">

                                    <!-- Label and Close Icon in the Same Row -->
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <!-- Label -->
                                        <label for="color-picker-{{ faculty.id }}" 
                                            class="form-label fw-bold mb-0" 
                                            style="font-size: 1.1rem; color: #333;">
                                            Update Color
                                        </label>

                                        <!-- Close Icon -->
                                        <i class="fas fa-times" 
                                        style="cursor: pointer; font-size: 1.2rem; color: #333;" 
                                        onclick="closeDropdown({{ faculty.id }})">
                                        </i>
                                    </div>

                                    <!-- Centered Color Picker and Random Button -->
                                    <div class="d-flex justify-content-center align-items-center mb-3">
                                        <!-- Color Picker -->
                                        <input type="color" id="color-picker-{{ faculty.id }}" 
                                            class="form-control border-0 shadow-sm" 
                                            style="width: 40px; height: 40px; cursor: pointer; padding: 0; margin: 0;">
                                        
                                        <!-- Random Button with Icon -->
                                        <button class="btn btn-secondary btn-sm d-flex align-items-center justify-content-center ms-2" 
                                            style="font-size: 1.2rem; padding: 0; height: 40px; width: 40px;" 
                                            onclick="generateRandomColor({{ faculty.id }})">
                                            <i class="fas fa-random" style="font-size: 1.2rem;"></i>
                                        </button>
                                    </div>

                                    <!-- Centered Button at the Bottom -->
                                    <button class="btn btn-primary btn-sm mx-auto d-block mb-2" 
                                        onclick="updateColor({{ faculty.id }})" 
                                        style="width: 100px;">
                                        Update
                                    </button>
                                
                                </div>
                            </div>
                        </div>
                    
                            <!-- Faculty Schedules List (Initially Hidden) -->
                            <ul id="schedule-list-{{ faculty.id }}" class="mt-2 ps-4 schedule-list" style="display: none;">
                                {% for event in schedules %}
                                    <li>
                                        <div class="schedule-dot" style="background-color: {{ faculty.color }};"></div>
                                        From: {{ event.start|date:"M. d, Y, g:i A" }} 
                                        To: {{ event.end|date:"M. d, Y, g:i A" }}
                                    </li>
                                {% empty %}
                                    <li class="text-muted">No schedules available.</li>
                                {% endfor %}
                            </ul>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </section>
        </div>
      
        
        <!-- Right Column: Calendar -->
        <div class="col-md-6"> 
            <div class="my_calendar" style="margin-top: 0px">
                <div id='calendar'></div> 
            </div>
        </div>
        

        <div class="col-md-3">

            <!-- Filter by Project Form -->
        <div class="mb-6">
            <form id="filter-project-form" method="GET" class="border p-3 rounded bg-light mb-3" action="{% url 'view-schedule' %}">
                <div class="mb-2">
                    <label for="project" class="form-label">Select Project Filter:</label>
                    <select name="project" id="project" class="form-control">
                        <option value="" {% if not request.GET.project %}selected{% endif %}>
                            All Project
                        </option>
                        {% for project in projects %}
                            <option value="{{ project.id }}"
                                {% if project.id|stringformat:"s" == request.GET.project %}selected{% endif %}>
                                {{ project.title }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                {% comment %} <button type="submit" class="btn btn-primary w-100">Apply Filter</button> {% endcomment %}
            </form>
        </div>
        
            <div class="mb-4">
                <section class="common-schedule-container mb-6 border p-3 rounded bg-light mb-3">
                    <h5 class="form-label text-center mb-3">Mutual Availability</h5>
                    
                    <ul id="common-schedule-list" class="list-group">
                        {% for start, end in common_schedules %}
                            <li class="list-group-item d-flex align-items-center">
                                <!-- Color Dot (Optional) -->
                                <div class="schedule-dot me-2" style="background-color: #007bff;"></div>     
                                <!-- Schedule Details -->
                                <div>
                                    <strong>From:</strong> {{ start|date:"M. d, Y, g:i A" }} <br>
                                    <strong>To:</strong> {{ end|date:"M. d, Y, g:i A" }}
                                </div>
                                 <!-- Link to redirect to calendar with view set to 'agendaDay' -->
                                <a href="{% url 'view-schedule' %}?start={{ start|date:'Y-m-d H:i' }}&end={{ end|date:'Y-m-d H:i' }}&view=agendaDay" class="stretched-link" data-start="{{ start|date:'Y-m-d H:i' }}" data-end="{{ end|date:'Y-m-d H:i' }}"></a>
                            </li>
                        {% empty %}
                            <li class="list-group-item text-center">No common schedules available</li>
                        {% endfor %}
                    </ul>
                </section>
            </div>
        </div>
    </div>

</div>
    {% include 'defense_schedule/create_defense_schedule_modal.html' %}
    
{% else %}
    <div class="text-center mt-5">
        <h1>Please login to view this page.</h1>
        <a href="{% url 'login' %}" class="btn btn-primary mt-3">Login Here</a>
    </div>
{% endif %}

</div>
<script>
    function generateRandomColor(facultyId) {
        // Generate a random hex color
        const randomColor = `#${Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0')}`;
    
        // Find the color picker input and set its value
        const colorPicker = document.getElementById(`color-picker-${facultyId}`);
        colorPicker.value = randomColor;
    
        // Optionally: Apply the color (e.g., update a preview or UI element)
        applyColorToUI(facultyId, randomColor);
    }
    
    function applyColorToUI(facultyId, color) {
        // Example: Update a preview dot or other element with the new color
        const previewDot = document.querySelector(`#schedule-list-${facultyId} .schedule-dot`);
        if (previewDot) {
            previewDot.style.backgroundColor = color;
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('filter-project-form');
        const projectSelect = document.getElementById('project');

        projectSelect.addEventListener('change', function() {
            form.submit();
        });
    });
    
    function toggleSchedules(facultyId) {
        const scheduleList = document.getElementById(`schedule-list-${facultyId}`);
        const toggleIcon = document.getElementById(`toggle-icon-${facultyId}`);
        
        if (scheduleList.style.display === "none" || scheduleList.style.display === "") {
            scheduleList.style.display = "block";  // Show schedules
            toggleIcon.classList.remove("fa-chevron-down");
            toggleIcon.classList.add("fa-chevron-up");
        } else {
            scheduleList.style.display = "none";   // Hide schedules
            toggleIcon.classList.remove("fa-chevron-up");
            toggleIcon.classList.add("fa-chevron-down");
        }
    }
    let currentOpenDropdown = null; // Store the currently open dropdown to close it when a new one is clicked

    function closeDropdown(facultyId) {
        const colorPickerDropdown = document.getElementById(`color-picker-dropdown-${facultyId}`);
        colorPickerDropdown.style.display = "none"; // Hide the dropdown
        currentOpenDropdown = null; // Reset the open dropdown state
    }
    // Toggle the visibility of the color picker dropdown
    function toggleColorPicker(facultyId) {
        const colorPickerDropdown = document.getElementById(`color-picker-dropdown-${facultyId}`);
        const scheduleList = document.getElementById(`schedule-list-${facultyId}`);
        const toggleIcon = document.getElementById(`toggle-icon-${facultyId}`);

        // If another dropdown is open, close it
        if (currentOpenDropdown && currentOpenDropdown !== colorPickerDropdown) {
            currentOpenDropdown.style.display = 'none';
        }

        // Toggle the dropdown for the clicked cog
        if (colorPickerDropdown.style.display === "none" || colorPickerDropdown.style.display === "") {
            colorPickerDropdown.style.display = "block";  // Show the dropdown
            currentOpenDropdown = colorPickerDropdown;    // Update the currently open dropdown
        } else {
            colorPickerDropdown.style.display = "none";  // Hide the dropdown
            currentOpenDropdown = null;
        }

        // Check if schedules are already visible
        if (scheduleList.style.display === "none" || scheduleList.style.display === "") {
            // If schedules are hidden, show them
            scheduleList.style.display = "block";
            toggleIcon.classList.remove("fa-chevron-down");
            toggleIcon.classList.add("fa-chevron-up");
        }
    }
    
    function updateColor(facultyId) {
        const colorPicker = document.getElementById(`color-picker-${facultyId}`);
        const colorPreview = document.getElementById(`color-preview-${facultyId}`);
        const newColor = colorPicker.value;
        
        // Update the preview color locally
        colorPreview.style.backgroundColor = newColor;
    
        // Perform AJAX POST request to update the color in the database
        fetch("{% url 'update_faculty_color' %}", {  // Replace with the correct URL name
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",  // CSRF token for security
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                faculty_id: facultyId,
                color: newColor
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log("Color updated successfully:", data.new_color);
                alert("Color updated successfully!");
                
                // Refresh FullCalendar events to apply the updated color
                $('#calendar').fullCalendar('refetchEvents');
                
                // Refresh the schedule dots list by updating the color of all dots related to this faculty
                document.querySelectorAll(`#schedule-list-${facultyId} .schedule-dot`).forEach(dot => {
                    dot.style.backgroundColor = newColor;
                });
    
            } else {
                console.error("Error updating color:", data.error);
                alert("Failed to update color. Please try again.");
            }
        })
        .catch(error => {
            console.error("AJAX error:", error);
            alert("An error occurred. Please try again.");
        });
    }
    
    

    // Close the color picker if clicked outside
    document.addEventListener("click", function(event) {
        const isClickInsideCog = event.target.closest(".fas.fa-cog");
        const isClickInsideDropdown = event.target.closest(".dropdown-menu");
        
        if (!isClickInsideCog && !isClickInsideDropdown) {
            // Close the dropdown if the click is outside the cog icon or dropdown
            if (currentOpenDropdown) {
                currentOpenDropdown.style.display = "none";
                currentOpenDropdown = null;
            }
        }
        document.getElementById('filter-project-form').addEventListener('submit', function(event) {
            const url = new URL(window.location.href);
            const params = new URLSearchParams(url.search);
        
            // Avoid appending duplicate 'project' parameters
            if (params.has('project')) {
                params.delete('project');
            }
            params.append('project', document.getElementById('project').value);
        
            // Update the form action with clean query parameters
            this.action = `${url.pathname}?${params.toString()}`;
        });
    });
    document.addEventListener('DOMContentLoaded', function () {
        const toggleButton = document.getElementById('toggle-button');
        const facultyContent = document.getElementById('faculty-content');

        toggleButton.addEventListener('click', function () {
            facultyContent.classList.toggle('hidden');
            toggleButton.textContent = facultyContent.classList.contains('hidden') ? 'Expand' : 'Minimize';
        });
    });

</script>

{% endblock %}
